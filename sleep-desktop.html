<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep - 0500</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Shared Theme -->
    <link rel="stylesheet" href="css/sleep-theme.css">

    <!-- Desktop-specific Layout -->
    <style>
        /* ═══════════════════════════════════════════════════════════════════════
           DESKTOP LAYOUT
           ═══════════════════════════════════════════════════════════════════════ */

        .page-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Floating orbs for desktop */
        .orb { position: fixed; }
        .orb-1 { width: 300px; height: 300px; top: -5%; left: -5%; }
        .orb-2 { width: 250px; height: 250px; bottom: 10%; right: -5%; }
        .orb-3 { width: 200px; height: 200px; top: 30%; right: 15%; }

        /* ─────────────────────────────────────────────────────────────────────────
           HEADER
           ───────────────────────────────────────────────────────────────────────── */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            transition: all var(--transition-normal);
        }

        .back-btn:hover {
            background: var(--card-bg-hover);
            color: var(--text-primary);
        }

        .back-btn svg {
            width: 18px;
            height: 18px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.05em;
        }

        /* ─────────────────────────────────────────────────────────────────────────
           QUICK ACTIONS
           ───────────────────────────────────────────────────────────────────────── */
        .quick-actions {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
        }

        .log-btn {
            flex: 1;
            max-width: 280px;
            padding: 24px 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 16px;
        }

        .log-btn .emoji {
            font-size: 28px;
        }

        /* ─────────────────────────────────────────────────────────────────────────
           MAIN GRID
           ───────────────────────────────────────────────────────────────────────── */
        .main-grid {
            display: grid;
            grid-template-columns: 340px 1fr 320px;
            grid-template-rows: auto auto auto;
            gap: 24px;
        }

        /* ─────────────────────────────────────────────────────────────────────────
           SCORE CARD (Left Column)
           ───────────────────────────────────────────────────────────────────────── */
        .score-card {
            grid-row: span 2;
            padding: 40px 32px;
            text-align: center;
        }

        .score-ring-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 32px;
        }

        .score-ring {
            width: 200px;
            height: 200px;
        }

        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .score-number {
            font-size: 72px;
        }

        .score-label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.2em;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .key-stats {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .key-stat {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 16px;
            color: var(--text-secondary);
        }

        .key-stat .icon {
            font-size: 24px;
        }

        .key-stat .value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 18px;
        }

        /* ─────────────────────────────────────────────────────────────────────────
           COUNTDOWN CARD (Center Top)
           ───────────────────────────────────────────────────────────────────────── */
        .countdown-card {
            padding: 32px;
        }

        .countdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .countdown-status {
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.15em;
            color: var(--text-muted);
        }

        .countdown-time {
            font-size: 64px;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            text-align: center;
            margin-bottom: 24px;
        }

        .countdown-stats {
            display: flex;
            justify-content: space-around;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .countdown-stat {
            text-align: center;
        }

        .countdown-stat-value {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .countdown-stat-label {
            font-size: 10px;
            font-weight: 500;
            color: var(--text-muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .quality-container {
            margin-top: 24px;
        }

        .quality-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 8px;
        }

        /* ─────────────────────────────────────────────────────────────────────────
           WEEK CHART (Center Bottom)
           ───────────────────────────────────────────────────────────────────────── */
        .week-card {
            padding: 28px;
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .mini-bars {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 120px;
            gap: 12px;
        }

        .mini-bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .mini-bar {
            width: 100%;
            max-width: 50px;
        }

        .mini-bar-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
        }

        .mini-bar-label.today {
            color: var(--accent);
            font-weight: 600;
        }

        .color-legend {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ─────────────────────────────────────────────────────────────────────────
           STATS CARD (Right Column Top)
           ───────────────────────────────────────────────────────────────────────── */
        .stats-card {
            padding: 28px;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-lg);
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.04);
            transition: all var(--transition-normal);
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* ─────────────────────────────────────────────────────────────────────────
           HEATMAP CARD (Bottom Spanning)
           ───────────────────────────────────────────────────────────────────────── */
        .heatmap-card {
            grid-column: 1 / -1;
            padding: 28px;
        }

        .heatmap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .heatmap-title {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .heatmap-nav {
            width: 36px;
            height: 36px;
        }

        .heatmap-month {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .heatmap-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 8px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .heatmap-cell {
            height: 48px;
            font-size: 13px;
        }

        /* ─────────────────────────────────────────────────────────────────────────
           SETTINGS ROW (Bottom)
           ───────────────────────────────────────────────────────────────────────── */
        .settings-row {
            grid-column: 1 / -1;
            display: flex;
            gap: 24px;
        }

        .settings-card {
            flex: 1;
            padding: 24px;
        }

        .settings-content {
            display: flex;
            gap: 16px;
        }

        .setting-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-item label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }

        .setting-item input {
            padding: 14px 16px;
            font-size: 16px;
        }

        .manual-card {
            flex: 1.5;
            padding: 24px;
        }

        .manual-content {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .manual-field {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .manual-field label {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }

        .manual-field input {
            padding: 12px 14px;
            font-size: 14px;
        }

        /* ─────────────────────────────────────────────────────────────────────────
           NATIVE INPUT OVERRIDES (Date/Time pickers)
           ───────────────────────────────────────────────────────────────────────── */
        input[type="date"],
        input[type="time"],
        input[type="number"] {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            color-scheme: dark;
        }

        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.7);
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        input[type="date"]::-webkit-calendar-picker-indicator:hover,
        input[type="time"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        input[type="date"]:focus,
        input[type="time"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        /* Number input spinner buttons */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 0.5;
            filter: invert(0.7);
        }

        input[type="number"]:hover::-webkit-inner-spin-button,
        input[type="number"]:hover::-webkit-outer-spin-button {
            opacity: 1;
        }

        .manual-add-btn {
            width: 52px;
            height: 52px;
            font-size: 24px;
            flex-shrink: 0;
        }

        /* ─────────────────────────────────────────────────────────────────────────
           CUSTOM DATE/TIME PICKER
           ───────────────────────────────────────────────────────────────────────── */
        .manual-card {
            flex: 2;
        }

        .date-selector {
            margin-bottom: 20px;
        }

        .date-pills {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .date-pill {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 70px;
        }

        .date-pill:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .date-pill.selected {
            background: rgba(255, 176, 144, 0.15);
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .date-pill.has-data {
            opacity: 0.4;
        }

        .date-pill.has-data::after {
            content: '✓';
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 10px;
            color: var(--data-good-start);
        }

        .date-pill-day {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .date-pill-date {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .date-pill-month {
            font-size: 10px;
            color: var(--text-muted);
        }

        .date-pill.selected .date-pill-day,
        .date-pill.selected .date-pill-month {
            color: var(--accent);
        }

        /* Time Selector */
        .time-selector {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .time-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .time-group label {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }

        .time-scroll-container {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 8px 12px;
        }

        .time-scroll {
            display: flex;
            gap: 4px;
        }

        .time-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .time-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            color: var(--text-primary);
        }

        .time-btn.selected {
            background: var(--accent);
            color: #000;
            font-weight: 600;
            border-color: var(--accent);
        }

        .time-separator {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-muted);
            margin: 0 2px;
        }

        .time-arrow {
            font-size: 20px;
            color: var(--text-muted);
            margin: 20px 8px 0;
        }

        .time-duration {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            background: rgba(125, 212, 160, 0.1);
            border: 1px solid rgba(125, 212, 160, 0.2);
            border-radius: 12px;
            margin-left: auto;
            margin-top: 18px;
        }

        .time-duration span {
            font-size: 18px;
            font-weight: 600;
            color: var(--data-good-start);
        }

        .time-duration.short span {
            color: var(--data-poor-start);
        }

        .time-duration.ok span {
            color: var(--data-ok-start);
        }

        .manual-add-btn {
            margin-top: 18px;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>

<!-- SVG Gradients -->
<svg width="0" height="0" style="position:absolute">
    <defs>
        <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#c87090"/>
            <stop offset="100%" style="stop-color:#ffb090"/>
        </linearGradient>
    </defs>
</svg>

<!-- Floating Orbs -->
<div class="orb orb-1"></div>
<div class="orb orb-2"></div>
<div class="orb orb-3"></div>

<!-- Page Container -->
<div class="page-container">

    <!-- Header -->
    <header class="page-header">
        <a href="index.html" class="back-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Dashboard
        </a>
        <h1 class="page-title">SLEEP</h1>
        <div style="width: 120px;"></div> <!-- Spacer for centering -->
    </header>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="btn-glass log-btn" id="btn-going-to-bed">
            <span class="emoji">&#127769;</span>
            Going to bed
        </button>
        <button class="btn-glass log-btn disabled" id="btn-woke-up">
            <span class="emoji">&#9728;&#65039;</span>
            Just woke up
        </button>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">

        <!-- Score Card -->
        <div class="glass-card score-card">
            <div class="score-ring-container">
                <svg class="score-ring" viewBox="0 0 200 200">
                    <circle class="score-ring-bg" cx="100" cy="100" r="86" />
                    <circle class="score-ring-fill" id="score-ring-fill" cx="100" cy="100" r="86" stroke="url(#scoreGradient)" stroke-dasharray="0 540" />
                </svg>
                <div class="score-value">
                    <div class="score-number" id="score-number">--</div>
                    <div class="score-label">SLEEP SCORE</div>
                </div>
            </div>

            <div class="key-stats">
                <div class="key-stat">
                    <span class="icon" id="streak-icon">&#128293;</span>
                    <span class="value" id="streak-count">0</span>
                    <span>day streak</span>
                </div>
                <div class="key-stat">
                    <span class="value" id="avg-hours">--</span>
                    <span>weekly avg</span>
                </div>
            </div>
        </div>

        <!-- Countdown Card -->
        <div class="glass-card countdown-card">
            <div class="countdown-header">
                <span class="countdown-status" id="countdown-status">TIME UNTIL BED</span>
            </div>
            <div class="countdown-time" id="countdown-time">0:00:00</div>

            <div class="countdown-stats">
                <div class="countdown-stat">
                    <div class="countdown-stat-value" id="bedtime-display">--:--</div>
                    <div class="countdown-stat-label">Bedtime</div>
                </div>
                <div class="countdown-stat">
                    <div class="countdown-stat-value" id="if-now-display">--</div>
                    <div class="countdown-stat-label">If Now</div>
                </div>
                <div class="countdown-stat">
                    <div class="countdown-stat-value" id="wake-display">--:--</div>
                    <div class="countdown-stat-label">Wake</div>
                </div>
            </div>

            <div class="quality-container">
                <div class="quality-bar">
                    <div class="quality-zone poor"></div>
                    <div class="quality-zone ok"></div>
                    <div class="quality-zone good"></div>
                    <div class="quality-zone ideal"></div>
                </div>
                <div class="quality-marker" id="quality-marker"></div>
                <div class="quality-labels">
                    <span>Terrible</span>
                    <span>Low</span>
                    <span>Solid</span>
                    <span>Ideal</span>
                </div>
            </div>
        </div>

        <!-- Stats Card -->
        <div class="glass-card stats-card">
            <div class="stats-header">
                <span class="section-header">STATISTICS</span>
                <div class="period-toggle">
                    <button class="period-btn active" data-period="7">7d</button>
                    <button class="period-btn" data-period="30">30d</button>
                </div>
            </div>
            <div class="stats-grid" id="stats-grid">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Week Chart Card -->
        <div class="glass-card week-card">
            <div class="week-header">
                <span class="section-header">LAST 7 NIGHTS</span>
            </div>
            <div class="mini-bars" id="mini-bars">
                <!-- Populated by JS -->
            </div>
            <div class="color-legend">
                <div class="legend-item"><span class="legend-dot good"></span> 7+ hrs</div>
                <div class="legend-item"><span class="legend-dot ok"></span> 5-7 hrs</div>
                <div class="legend-item"><span class="legend-dot poor"></span> &lt;5 hrs</div>
            </div>
        </div>

        <!-- Heatmap Card -->
        <div class="glass-card heatmap-card">
            <div class="heatmap-header">
                <span class="section-header">MONTHLY VIEW</span>
                <div class="heatmap-title">
                    <button class="nav-btn heatmap-nav" id="heatmap-prev">&lt;</button>
                    <span class="heatmap-month" id="heatmap-month">January 2026</span>
                    <button class="nav-btn heatmap-nav" id="heatmap-next">&gt;</button>
                </div>
            </div>
            <div class="heatmap-weekdays">
                <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
            </div>
            <div class="heatmap-grid" id="heatmap-grid">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Settings Row -->
        <div class="settings-row">
            <div class="glass-card settings-card">
                <div class="section-header" style="margin-bottom: 16px;">SETTINGS</div>
                <div class="settings-content">
                    <div class="setting-item">
                        <label>WAKE TIME</label>
                        <input type="time" id="wake-input" class="input-glass" value="05:00">
                    </div>
                    <div class="setting-item">
                        <label>TARGET HOURS</label>
                        <input type="number" id="hours-input" class="input-glass" value="7.5" min="4" max="12" step="0.5">
                    </div>
                </div>
            </div>

            <div class="glass-card manual-card">
                <div class="section-header" style="margin-bottom: 16px;">ADD PAST ENTRY</div>

                <!-- Date Selection - Recent Days -->
                <div class="date-selector">
                    <div class="date-pills" id="date-pills">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Time Selection -->
                <div class="time-selector">
                    <div class="time-group">
                        <label>BEDTIME</label>
                        <div class="time-scroll-container">
                            <div class="time-scroll" id="bed-hour-scroll" data-type="bed-hour"></div>
                            <span class="time-separator">:</span>
                            <div class="time-scroll" id="bed-min-scroll" data-type="bed-min"></div>
                        </div>
                    </div>
                    <div class="time-arrow">→</div>
                    <div class="time-group">
                        <label>WAKE</label>
                        <div class="time-scroll-container">
                            <div class="time-scroll" id="wake-hour-scroll" data-type="wake-hour"></div>
                            <span class="time-separator">:</span>
                            <div class="time-scroll" id="wake-min-scroll" data-type="wake-min"></div>
                        </div>
                    </div>
                    <div class="time-duration">
                        <span id="duration-preview">8h 0m</span>
                    </div>
                    <button class="btn-accent manual-add-btn" id="manual-add">+</button>
                </div>
            </div>
        </div>

    </div>

</div>

<!-- Scripts -->
<script src="js/config.js?v=4"></script>
<script src="js/sleep.js?v=5"></script>
<script>
// ═══════════════════════════════════════════════════════════════════════════════
// SLEEP PAGE - Desktop Layout
// ═══════════════════════════════════════════════════════════════════════════════

let currentStatsPeriod = 7;
let heatmapYear = new Date().getFullYear();
let heatmapMonth = new Date().getMonth();

// ═══════════════════════════════════════════════════════════════════════════════
// RENDER FUNCTIONS
// ═══════════════════════════════════════════════════════════════════════════════

function renderScoreHero() {
    const last14 = getLastNDaysLog(14);
    const score = calculateSleepScore(last14);
    const streak = calculateSleepStreak();
    const avg = calculateWeeklyAverage();

    const scoreNumber = document.getElementById('score-number');
    const scoreRing = document.getElementById('score-ring-fill');

    if (score) {
        scoreNumber.textContent = score.total;
        // Circumference = 2 * PI * 86 ≈ 540
        const dashArray = (score.total / 100) * 540;
        scoreRing.setAttribute('stroke-dasharray', `${dashArray} 540`);
    } else {
        scoreNumber.textContent = '--';
        scoreRing.setAttribute('stroke-dasharray', '0 540');
    }

    document.getElementById('streak-count').textContent = streak.current;
    document.getElementById('streak-icon').style.opacity = streak.current > 0 ? '1' : '0.3';
    document.getElementById('avg-hours').textContent = avg ? `${avg.toFixed(1)}h` : '--';
}

function renderMiniBars() {
    const container = document.getElementById('mini-bars');
    const weekData = getLastNDaysLog(7);
    const maxHours = 10;
    const today = new Date().toISOString().split('T')[0];

    let html = '';
    weekData.forEach(day => {
        const height = day.duration ? Math.max(8, (day.duration / maxHours) * 120) : 8;
        const colorClass = getBarColor(day.duration);
        const isToday = day.date === today;

        html += `
            <div class="mini-bar-group">
                <div class="data-bar mini-bar ${colorClass}" style="height: ${height}px;"></div>
                <span class="mini-bar-label ${isToday ? 'today' : ''}">${day.dayName}</span>
            </div>
        `;
    });

    container.innerHTML = html;
}

function getBarColor(hours) {
    if (hours === null) return 'none';
    if (hours < 5) return 'poor';
    if (hours < 7) return 'ok';
    return 'good';
}

function renderStats() {
    const container = document.getElementById('stats-grid');
    const days = getLastNDaysLog(currentStatsPeriod);
    const stats = calculatePeriodStats(days);

    container.innerHTML = `
        <div class="stat-item">
            <div class="stat-value">${stats.avgDuration ? stats.avgDuration.toFixed(1) + 'h' : '--'}</div>
            <div class="stat-label">Avg Duration</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${stats.avgBedtime ? formatTime12HourShort(stats.avgBedtime.hour, stats.avgBedtime.minute) : '--'}</div>
            <div class="stat-label">Avg Bedtime</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${stats.avgWakeTime ? formatTime12HourShort(stats.avgWakeTime.hour, stats.avgWakeTime.minute) : '--'}</div>
            <div class="stat-label">Avg Wake</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${stats.nightsLogged}</div>
            <div class="stat-label">Nights Logged</div>
        </div>
    `;
}

function formatTime12HourShort(hour, minute) {
    const period = hour >= 12 ? 'p' : 'a';
    const displayHour = hour % 12 || 12;
    const displayMin = minute.toString().padStart(2, '0');
    return `${displayHour}:${displayMin}${period}`;
}

function renderHeatmap() {
    const container = document.getElementById('heatmap-grid');
    const monthLabel = document.getElementById('heatmap-month');

    const monthData = getMonthLog(heatmapYear, heatmapMonth);
    const monthName = new Date(heatmapYear, heatmapMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    monthLabel.textContent = monthName;

    const firstDayOfWeek = new Date(heatmapYear, heatmapMonth, 1).getDay();
    const today = new Date().toISOString().split('T')[0];

    let html = '';

    for (let i = 0; i < firstDayOfWeek; i++) {
        html += '<div class="heatmap-cell empty"></div>';
    }

    monthData.forEach(day => {
        const color = getSleepColor(day.duration);
        const isToday = day.date === today;
        const isFuture = new Date(day.date) > new Date();

        html += `
            <div class="heatmap-cell ${color} ${isToday ? 'today' : ''} ${isFuture ? 'future' : ''}"
                 title="${day.duration ? day.duration.toFixed(1) + 'h' : 'No data'}">
                ${day.day}
            </div>
        `;
    });

    container.innerHTML = html;
}

function updateCountdown() {
    const settings = loadSleepSettings();
    const bedtime = calculateBedtime(settings);
    const msUntilBedtime = getTimeUntilBedtime(settings);
    const msIfSleepNow = getSleepIfNow(settings);
    const state = getSleepState(msUntilBedtime);
    const qualityPercent = getQualityPercent(msIfSleepNow / 1000 / 60 / 60);

    document.getElementById('countdown-time').textContent = formatCountdown(Math.max(0, msUntilBedtime));

    const statusEl = document.getElementById('countdown-status');
    if (state === 'urgent') {
        statusEl.textContent = 'YOU SHOULD BE SLEEPING';
    } else if (state === 'warning') {
        statusEl.textContent = 'GO TO BED SOON';
    } else if (state === 'caution') {
        statusEl.textContent = 'START WINDING DOWN';
    } else {
        statusEl.textContent = 'TIME UNTIL BED';
    }

    document.getElementById('bedtime-display').textContent = formatTime12HourShort(bedtime.hour, bedtime.minute);
    document.getElementById('if-now-display').textContent = formatHoursMinutes(msIfSleepNow);
    document.getElementById('wake-display').textContent = formatTime12HourShort(settings.wakeHour, settings.wakeMinute);

    document.getElementById('quality-marker').style.marginLeft = `calc(${qualityPercent}% - 2px)`;
}

function updateButtonStates() {
    const log = loadSleepLog();
    const lastEntry = log[log.length - 1];
    const pendingBedtime = lastEntry && lastEntry.bedtime && !lastEntry.wakeTime;

    const goingToBedBtn = document.getElementById('btn-going-to-bed');
    const wokeUpBtn = document.getElementById('btn-woke-up');

    if (pendingBedtime) {
        goingToBedBtn.classList.add('disabled');
        wokeUpBtn.classList.remove('disabled');
    } else {
        goingToBedBtn.classList.remove('disabled');
        wokeUpBtn.classList.add('disabled');
    }
}

function refreshAll() {
    renderScoreHero();
    renderMiniBars();
    renderStats();
    renderHeatmap();
    updateCountdown();
    updateButtonStates();
}

// ═══════════════════════════════════════════════════════════════════════════════
// EVENT LISTENERS
// ═══════════════════════════════════════════════════════════════════════════════

document.addEventListener('DOMContentLoaded', () => {
    const settings = loadSleepSettings();
    const wakeInput = document.getElementById('wake-input');
    const hoursInput = document.getElementById('hours-input');

    wakeInput.value = `${settings.wakeHour.toString().padStart(2, '0')}:${settings.wakeMinute.toString().padStart(2, '0')}`;
    hoursInput.value = settings.targetSleepHours;

    const manualDate = document.getElementById('manual-date');
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    manualDate.value = yesterday.toISOString().split('T')[0];
    manualDate.max = new Date().toISOString().split('T')[0];

    refreshAll();
    setInterval(updateCountdown, 1000);

    // Going to bed
    document.getElementById('btn-going-to-bed').addEventListener('click', function() {
        if (!this.classList.contains('disabled')) {
            const bedtime = logBedtime();
            this.innerHTML = `Logged ${formatTime12HourShort(bedtime.getHours(), bedtime.getMinutes())}`;
            setTimeout(() => {
                this.innerHTML = '<span class="emoji">&#127769;</span> Going to bed';
            }, 2000);
            refreshAll();
        }
    });

    // Woke up
    document.getElementById('btn-woke-up').addEventListener('click', function() {
        if (!this.classList.contains('disabled')) {
            const wakeTime = logWakeUp();
            this.innerHTML = `Logged ${formatTime12HourShort(wakeTime.getHours(), wakeTime.getMinutes())}`;
            setTimeout(() => {
                this.innerHTML = '<span class="emoji">&#9728;&#65039;</span> Just woke up';
            }, 2000);
            refreshAll();
        }
    });

    // Settings
    wakeInput.addEventListener('change', () => {
        const [h, m] = wakeInput.value.split(':').map(Number);
        const settings = loadSleepSettings();
        settings.wakeHour = h;
        settings.wakeMinute = m;
        saveSleepSettings(settings);
        refreshAll();
    });

    hoursInput.addEventListener('change', () => {
        const settings = loadSleepSettings();
        settings.targetSleepHours = parseFloat(hoursInput.value) || 7.5;
        saveSleepSettings(settings);
        refreshAll();
    });

    // Period toggle
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentStatsPeriod = parseInt(btn.dataset.period);
            renderStats();
        });
    });

    // Heatmap nav
    document.getElementById('heatmap-prev').addEventListener('click', () => {
        heatmapMonth--;
        if (heatmapMonth < 0) { heatmapMonth = 11; heatmapYear--; }
        renderHeatmap();
    });

    document.getElementById('heatmap-next').addEventListener('click', () => {
        heatmapMonth++;
        if (heatmapMonth > 11) { heatmapMonth = 0; heatmapYear++; }
        renderHeatmap();
    });

    // Custom Date/Time Picker
    initCustomDateTimePicker();
});

// ═══════════════════════════════════════════════════════════════════════════════
// CUSTOM DATE/TIME PICKER
// ═══════════════════════════════════════════════════════════════════════════════

let selectedDate = null;
let selectedBedHour = 22;
let selectedBedMin = 0;
let selectedWakeHour = 6;
let selectedWakeMin = 0;

function initCustomDateTimePicker() {
    renderDatePills();
    renderTimeSelectors();
    updateDurationPreview();

    // Add button
    document.getElementById('manual-add').addEventListener('click', addManualEntry);
}

function renderDatePills() {
    const container = document.getElementById('date-pills');
    const log = loadSleepLog();
    let html = '';

    // Generate last 7 days
    for (let i = 1; i <= 7; i++) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const dayNum = date.getDate();
        const monthName = date.toLocaleDateString('en-US', { month: 'short' });

        const hasData = log.some(e => e.date === dateStr && e.duration);
        const isSelected = selectedDate === dateStr;

        html += `
            <div class="date-pill ${isSelected ? 'selected' : ''} ${hasData ? 'has-data' : ''}"
                 data-date="${dateStr}" onclick="selectDate('${dateStr}')">
                <span class="date-pill-day">${dayName}</span>
                <span class="date-pill-date">${dayNum}</span>
                <span class="date-pill-month">${monthName}</span>
            </div>
        `;
    }

    container.innerHTML = html;

    // Auto-select first date without data
    if (!selectedDate) {
        const firstEmpty = document.querySelector('.date-pill:not(.has-data)');
        if (firstEmpty) {
            selectDate(firstEmpty.dataset.date);
        }
    }
}

// Expose to global scope for onclick handlers
window.selectDate = function(dateStr) {
    selectedDate = dateStr;
    document.querySelectorAll('.date-pill').forEach(pill => {
        pill.classList.toggle('selected', pill.dataset.date === dateStr);
    });
}

function renderTimeSelectors() {
    // Bed hours (8 PM - 2 AM)
    const bedHours = [20, 21, 22, 23, 0, 1, 2];
    renderTimeGroup('bed-hour-scroll', bedHours, selectedBedHour, 'bedHour', formatHour);

    // Bed minutes
    const minutes = [0, 15, 30, 45];
    renderTimeGroup('bed-min-scroll', minutes, selectedBedMin, 'bedMin', formatMin);

    // Wake hours (4 AM - 10 AM)
    const wakeHours = [4, 5, 6, 7, 8, 9, 10];
    renderTimeGroup('wake-hour-scroll', wakeHours, selectedWakeHour, 'wakeHour', formatHour);

    // Wake minutes
    renderTimeGroup('wake-min-scroll', minutes, selectedWakeMin, 'wakeMin', formatMin);
}

function renderTimeGroup(containerId, values, selected, type, formatter) {
    const container = document.getElementById(containerId);
    if (!container) return;

    let html = '';
    values.forEach(val => {
        const isSelected = val === selected;
        html += `
            <button type="button" class="time-btn ${isSelected ? 'selected' : ''}"
                    onclick="selectTime('${type}', ${val}, this)">${formatter(val)}</button>
        `;
    });

    container.innerHTML = html;
}

// Global function for time selection
window.selectTime = function(type, value, btn) {
    // Update the selected value
    if (type === 'bedHour') selectedBedHour = value;
    else if (type === 'bedMin') selectedBedMin = value;
    else if (type === 'wakeHour') selectedWakeHour = value;
    else if (type === 'wakeMin') selectedWakeMin = value;

    // Update button states
    const container = btn.parentElement;
    container.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');

    // Update duration preview
    updateDurationPreview();
}

function formatHour(h) {
    const period = h >= 12 ? 'p' : 'a';
    const display = h % 12 || 12;
    return `${display}${period}`;
}

function formatMin(m) {
    return m.toString().padStart(2, '0');
}

function updateDurationPreview() {
    const bedMins = selectedBedHour * 60 + selectedBedMin;
    const wakeMins = selectedWakeHour * 60 + selectedWakeMin;

    let durationMins = wakeMins - bedMins;
    if (durationMins < 0) durationMins += 24 * 60; // overnight

    const hours = Math.floor(durationMins / 60);
    const mins = durationMins % 60;

    const preview = document.getElementById('duration-preview');
    const container = preview.parentElement;

    preview.textContent = `${hours}h ${mins}m`;

    container.classList.remove('short', 'ok');
    if (hours < 5) {
        container.classList.add('short');
    } else if (hours < 7) {
        container.classList.add('ok');
    }
}

function addManualEntry() {
    if (!selectedDate) {
        // Flash the date pills to indicate selection needed
        document.getElementById('date-pills').style.animation = 'shake 0.3s';
        setTimeout(() => {
            document.getElementById('date-pills').style.animation = '';
        }, 300);
        return;
    }

    const bedDate = new Date(selectedDate);
    bedDate.setHours(selectedBedHour, selectedBedMin, 0, 0);

    // If bedtime is late night (after midnight display), it's actually previous day
    if (selectedBedHour < 12) {
        // bed hour like 1am, 2am means previous calendar day
    } else {
        // bed hour like 10pm, 11pm - set to previous day since date is wake date
        bedDate.setDate(bedDate.getDate() - 1);
    }

    const wakeDate = new Date(selectedDate);
    wakeDate.setHours(selectedWakeHour, selectedWakeMin, 0, 0);

    const duration = (wakeDate - bedDate) / 1000 / 60 / 60;

    const log = loadSleepLog();
    const existingIdx = log.findIndex(e => e.date === selectedDate);
    const entry = {
        date: selectedDate,
        bedtime: bedDate.toISOString(),
        wakeTime: wakeDate.toISOString(),
        duration: duration
    };

    if (existingIdx >= 0) {
        log[existingIdx] = entry;
    } else {
        log.push(entry);
        log.sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    saveSleepLog(log);

    // Feedback
    const btn = document.getElementById('manual-add');
    btn.textContent = '✓';
    btn.style.background = 'var(--data-good-start)';

    setTimeout(() => {
        btn.textContent = '+';
        btn.style.background = '';
        selectedDate = null;
        renderDatePills();
        refreshAll();
    }, 800);
}
</script>

</body>
</html>
